<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸŒ™âœ¨ MAGICKAL MORTALZ COVEN - CLIENT-SIDE JAVASCRIPT âœ¨ğŸŒ™
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“… 2025
   ğŸ¨ Mystical UI Architecture (Modal Fix)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ—ƒï¸ GLOBAL STATE & MYSTICAL CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const APP_STATE = {
    currentMemberId: null,
    member: null,
    progress: null,
    attendance: null,
    grimoire: null,
    upcomingSabbats: [],
    curriculum: null,
    grimoireCategories: [],
    isLoading: false,
    moonPhase: 'ğŸŒ•' // Default
};

// ğŸŒ‘ Moon Phase Calculation
function getMoonPhase() {
    const d = new Date();
    let year = d.getFullYear();
    let month = d.getMonth() + 1;
    let day = d.getDate();

    if (month < 3) {
        year--;
        month += 12;
    }

    ++month;
    let c = 365.25 * year;
    let e = 30.6 * month;
    let jd = c + e + day - 694039.09; // jd is total days elapsed
    jd /= 29.5305882; // divide by the moon cycle
    let b = parseInt(jd); // int(jd) -> b, take integer part of jd
    jd -= b; // subtract integer part to leave fractional part of original jd
    b = Math.round(jd * 8); // scale fraction from 0-8 and round

    if (b >= 8) b = 0; // 0 and 8 are the same so turn 8 into 0

    const phases = {
        0: 'ğŸŒ‘ New Moon',
        1: 'ğŸŒ’ Waxing Crescent',
        2: 'ğŸŒ“ First Quarter',
        3: 'ğŸŒ” Waxing Gibbous',
        4: 'ğŸŒ• Full Moon',
        5: 'ğŸŒ– Waning Gibbous',
        6: 'ğŸŒ— Last Quarter',
        7: 'ğŸŒ˜ Waning Crescent'
    };
    
    return phases[b];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸš€ INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸŒ™ Magickal Mortalz Coven App initializing...');
    
    // ğŸ›¡ï¸ MODAL SAFETY: Close all modals on load
    closeAllModals();
    
    // ğŸ”® Initialize Mystical Elements
    initMoonPhase();
    initCursorEffects();
    
    // ğŸ” Check for existing member or create demo
    initializeApp();
});

function initMoonPhase() {
    const phase = getMoonPhase();
    APP_STATE.moonPhase = phase;
    const moonDisplay = document.getElementById('moon-phase-display');
    if (moonDisplay) moonDisplay.textContent = phase;
}

function initializeApp() {
    const demoMemberId = localStorage.getItem('covenMemberId');
    if (demoMemberId) {
        APP_STATE.currentMemberId = demoMemberId;
        loadDashboardData(demoMemberId);
    } else {
        createDemoMember();
    }
}

function createDemoMember() {
    showLoading(true);
    const memberData = {
        email: 'demo@magickalmortalz.com',
        craftName: 'Moonchild',
        realName: 'Demo User',
        bio: 'A seeker of ancient wisdom, walking the path of the Craft.'
    };
    
    google.script.run
        .withSuccessHandler(result => {
            if (result && result.success) {
                APP_STATE.currentMemberId = result.memberId;
                localStorage.setItem('covenMemberId', result.memberId);
                showToast('success', 'âœ¨ Blessed Be! Welcome to the Coven.');
                loadDashboardData(result.memberId);
            } else {
                showToast('error', 'Failed to summon member data.');
                showLoading(false);
            }
        })
        .withFailureHandler(error => {
            showToast('error', 'Connection severed by spirits.');
            showLoading(false);
        })
        .createMember(memberData);
}

function loadDashboardData(memberId) {
    showLoading(true);
    google.script.run
        .withSuccessHandler(data => {
            if (data && data.success) {
                APP_STATE.member = data.member;
                APP_STATE.progress = data.progress;
                APP_STATE.attendance = data.attendance;
                APP_STATE.grimoire = data.grimoire;
                APP_STATE.upcomingSabbats = data.upcomingSabbats;
                APP_STATE.curriculum = data.curriculum;
                APP_STATE.grimoireCategories = data.grimoireCategories;
                
                updateAllUI();
                showToast('success', 'âœ¨ Magick successfully invoked.');
            } else {
                showToast('error', 'Failed to read the stars.');
            }
            showLoading(false);
        })
        .withFailureHandler(error => {
            showToast('error', 'The spirits are silent.');
            showLoading(false);
        })
        .getDashboardData(memberId);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¨ UI UPDATE FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateAllUI() {
    updateUserMini();
    updateDashboardStats();
    updateUpcomingSabbats();
    updateCurriculumProgress();
    updateAttendanceSection();
    updateGrimoireSection();
    updateProfileSection();
}

function updateUserMini() {
    const member = APP_STATE.member;
    if (!member) return;
    
    document.getElementById('user-avatar').textContent = member.Avatar || 'ğŸ§™â€â™‚ï¸';
    document.getElementById('user-craft-name').textContent = member.CraftName || 'Witch';
    document.getElementById('user-degree').textContent = member.CurrentDegree || 'Neophyte';
}

function updateDashboardStats() {
    const { progress, attendance, grimoire, member } = APP_STATE;
    
    if (progress?.stats) {
        document.getElementById('stat-progress').textContent = (progress.stats.percentComplete || 0) + '%';
        const dashBar = document.getElementById('dashboard-progress-bar');
        if (dashBar) dashBar.style.width = (progress.stats.percentComplete || 0) + '%';
    }
    
    if (attendance?.stats) {
        document.getElementById('stat-sabbats').textContent = (attendance.stats.sabbatsAttended || 0) + '/8';
        document.getElementById('stat-esbats').textContent = attendance.stats.esbatsAttended || 0;
    }
    
    if (grimoire?.stats) {
        document.getElementById('stat-grimoire').textContent = grimoire.stats.totalEntries || 0;
    }
    
    if (member) {
        const tag = document.getElementById('dashboard-degree-tag');
        if (tag) tag.textContent = member.CurrentDegree || 'Neophyte';
    }
}

function updateUpcomingSabbats() {
    const container = document.getElementById('upcoming-sabbats');
    const sabbats = APP_STATE.upcomingSabbats;
    
    if (!sabbats || sabbats.length === 0) {
        container.innerHTML = '<p class="loading-placeholder">The Wheel is turning...</p>';
        return;
    }
    
    container.innerHTML = sabbats.map(sabbat => `
        <div class="upcoming-card">
            <div class="upcoming-emoji">${sabbat.emoji}</div>
            <div class="upcoming-name">${sabbat.name}</div>
            <div class="upcoming-date">${sabbat.dateString}</div>
            <div class="upcoming-days">${sabbat.daysUntil} days</div>
        </div>
    `).join('');
}

function updateCurriculumProgress() {
    const progress = APP_STATE.progress;
    if (!progress?.stats) return;
    
    const overallBar = document.getElementById('curriculum-overall-progress');
    const overallText = document.getElementById('curriculum-progress-text');
    if (overallBar) overallBar.style.width = (progress.stats.percentComplete || 0) + '%';
    if (overallText) overallText.textContent = (progress.stats.percentComplete || 0) + '%';
    
    // Stats Counters
    const modCompleted = document.getElementById('modules-completed');
    const modInProgress = document.getElementById('modules-in-progress');
    const modRemaining = document.getElementById('modules-remaining');
    
    if (modCompleted) modCompleted.textContent = progress.stats.completed || 0;
    if (modInProgress) modInProgress.textContent = progress.stats.inProgress || 0;
    if (modRemaining) modRemaining.textContent = progress.stats.notStarted || 0;
    
    // Year Progress Bars
    const byYear = progress.byYear || {};
    [1, 2, 3, 4].forEach(year => {
        const yearData = byYear['year' + year] || [];
        const completed = yearData.filter(m => m.Status === 'Completed').length;
        const total = yearData.length || 8;
        const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
        
        const bar = document.getElementById('year' + year + '-progress');
        if (bar) bar.style.width = percent + '%';
    });
}

function updateAttendanceSection() {
    const attendance = APP_STATE.attendance;
    if (!attendance) return;
    
    if (attendance.stats) {
        document.getElementById('att-sabbat-count').textContent = (attendance.stats.sabbatsAttended || 0) + '/8';
        document.getElementById('att-esbat-count').textContent = attendance.stats.esbatsAttended || 0;
    }
    
    const sabbatGrid = document.getElementById('sabbat-grid');
    const records = attendance.records || [];
    
    if (sabbatGrid) {
        sabbatGrid.innerHTML = (attendance.sabbats || []).map(sabbat => {
            const attended = records.some(r => 
                r.EventName && sabbat.name &&
                r.EventName.toLowerCase().includes(sabbat.name.toLowerCase()) && 
                (r.Attended === true || r.Attended === 'TRUE')
            );
            
            return `
                <div class="sabbat-item ${attended ? 'attended' : ''}" onclick="quickRecordSabbat('${sabbat.name}')">
                    <div class="sabbat-emoji">${sabbat.emoji}</div>
                    <div class="sabbat-name">${sabbat.name}</div>
                    <div class="sabbat-date">${sabbat.date}</div>
                    ${attended ? '<div class="status-badge present">âœ“ Present</div>' : ''}
                </div>
            `;
        }).join('');
    }
    
    const tbody = document.getElementById('attendance-tbody');
    if (tbody) {
        tbody.innerHTML = records.length ? records.slice(0, 10).map(record => `
            <tr>
                <td><strong>${record.EventName}</strong></td>
                <td>${record.EventType}</td>
                <td>${formatDisplayDate(record.EventDate)}</td>
                <td><span class="status-badge ${record.Attended === true || record.Attended === 'TRUE' ? 'present' : 'absent'}">
                    ${record.Attended === true || record.Attended === 'TRUE' ? 'âœ“ Present' : 'âœ— Absent'}
                </span></td>
                <td>${record.Notes || '-'}</td>
            </tr>
        `).join('') : '<tr><td colspan="5" style="text-align: center;">No records in the archives.</td></tr>';
    }
}

function updateGrimoireSection() {
    const grimoire = APP_STATE.grimoire;
    if (!grimoire) return;
    
    const categories = grimoire.categories || [];
    const options = categories.map(c => `<option value="${c.id}">${c.emoji} ${c.name}</option>`).join('');
    
    const filter = document.getElementById('grimoire-category-filter');
    const entryCat = document.getElementById('entry-category');
    
    if (filter) filter.innerHTML = '<option value="all">ğŸ”® All Magic</option>' + options;
    if (entryCat) entryCat.innerHTML = options;
    
    const statsContainer = document.getElementById('grimoire-category-stats');
    if (grimoire.stats?.byCategory) {
        statsContainer.innerHTML = categories.map(cat => {
            const count = grimoire.stats.byCategory[cat.id] || 0;
            return count ? `<div class="tag">${cat.emoji} ${cat.name}: ${count}</div>` : '';
        }).join('');
    }
    
    const entriesGrid = document.getElementById('grimoire-entries');
    const entries = grimoire.entries || [];
    
    entriesGrid.innerHTML = entries.length ? entries.map(entry => {
        const cat = categories.find(c => c.id === entry.Category) || { emoji: 'ğŸ“' };
        const tags = entry.Tags ? entry.Tags.split(',').filter(t => t) : [];
        
        return `
            <div class="grimoire-entry" onclick="viewGrimoireEntry('${entry.ID}')">
                <div class="entry-header">
                    <span class="entry-emoji">${cat.emoji}</span>
                    <span class="entry-title">${entry.Title}</span>
                </div>
                <div class="entry-date">${formatDisplayDate(entry.CreatedDate)}</div>
                <div class="entry-preview">${entry.Content.substring(0, 120)}...</div>
                <div class="entry-tags">
                    ${tags.slice(0, 3).map(t => `<span class="entry-tag">${t}</span>`).join('')}
                </div>
            </div>
        `;
    }).join('') : '<p class="loading-placeholder">Your Book of Shadows is waiting for its first spell...</p>';
}

function updateProfileSection() {
    const member = APP_STATE.member;
    if (!member) return;
    
    document.getElementById('profile-avatar').textContent = member.Avatar || 'ğŸ§™â€â™‚ï¸';
    document.getElementById('profile-craft-name').textContent = member.CraftName || 'Unnamed';
    document.getElementById('profile-degree').textContent = member.CurrentDegree;
    document.getElementById('profile-join-date').textContent = formatDisplayDate(member.JoinDate);
    document.getElementById('profile-email').textContent = member.Email;
    document.getElementById('profile-real-name').textContent = member.RealName || 'Hidden';
    document.getElementById('profile-bio').textContent = member.Bio || 'No story written yet...';
    
    if (APP_STATE.progress?.stats) {
        document.getElementById('journey-modules').textContent = APP_STATE.progress.stats.completed || 0;
    }
    if (APP_STATE.attendance?.stats) {
        document.getElementById('journey-sabbats').textContent = APP_STATE.attendance.stats.sabbatsAttended || 0;
    }
    if (APP_STATE.grimoire?.stats) {
        document.getElementById('journey-entries').textContent = APP_STATE.grimoire.stats.totalEntries || 0;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸª„ MYSTICAL INTERACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function initCursorEffects() {
    document.addEventListener('mousemove', function(e) {
        if (Math.random() < 0.1) { // Don't create too many particles
            createStarParticle(e.clientX, e.clientY);
        }
    });
}

function createStarParticle(x, y) {
    const star = document.createElement('div');
    star.textContent = 'âœ¨';
    star.style.position = 'fixed';
    star.style.left = x + 'px';
    star.style.top = y + 'px';
    star.style.fontSize = Math.random() * 10 + 5 + 'px';
    star.style.pointerEvents = 'none';
    star.style.animation = 'stars-twinkle 1s ease-out forwards';
    star.style.zIndex = '9999';
    star.style.color = '#FEF3C7'; // Light gold
    
    document.body.appendChild(star);
    
    setTimeout(() => {
        star.remove();
    }, 1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸš¦ NAVIGATION & MODALS [CRITICAL FIX: Modal Manager]
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showSection(sectionId, clickedLink) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');
    
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    if (clickedLink) clickedLink.classList.add('active');
    
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('main-content').scrollTop = 0;
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
}

// ğŸ›¡ï¸ CLOSE ALL MODALS before opening new ones
function closeAllModals() {
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.classList.remove('active');
    });
    document.body.style.overflow = '';
}

function openModal(modalId) {
    closeAllModals(); // Ensure exclusivity
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    } else {
        console.error('Modal not found:', modalId);
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }
}

// Close on backdrop click (Event Delegation)
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-overlay')) {
        e.target.classList.remove('active');
        document.body.style.overflow = '';
    }
});

// Close on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeAllModals();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“ ACTIONS (CRUD)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ğŸ“š Open Year Modal & Handle Modules
function openYearModal(year) {
    const modal = document.getElementById('modal-year');
    const content = document.getElementById('year-modal-content');
    const progress = APP_STATE.progress;
    const curriculum = APP_STATE.curriculum;
    
    if (!curriculum) return;
    
    const yearKey = 'year' + year;
    const yearData = curriculum[yearKey];
    const yearProgress = progress && progress.byYear ? progress.byYear[yearKey] : [];
    
    content.innerHTML = `
        <h2 style="color:var(--primary)">${yearData.emoji} Year ${year}: ${yearData.name}</h2>
        <div class="module-list" style="margin-top:1rem">
            ${yearData.modules.map((module, index) => {
                const moduleProgress = yearProgress.find(p => p.Module === module);
                const status = moduleProgress ? moduleProgress.Status : 'Locked';
                let statusIcon = 'ğŸ”’';
                let btnHtml = '';
                
                if (status === 'Completed') statusIcon = 'âœ…';
                else if (status === 'In Progress') statusIcon = 'ğŸ“–';
                
                if (moduleProgress && status !== 'Completed') {
                   btnHtml = `<button class="btn-secondary" style="padding:4px 8px; font-size:0.8rem" onclick="updateModuleStatus('${moduleProgress.ID}', '${status === 'In Progress' ? 'Completed' : 'In Progress'}')">${status === 'In Progress' ? 'Complete' : 'Start'}</button>`; 
                }
                
                return `
                    <div class="card" style="display:flex; align-items:center; gap:1rem; padding:1rem; margin-bottom:0.5rem">
                        <span style="font-size:1.5rem">${statusIcon}</span>
                        <div style="flex:1">
                            <strong style="color:var(--text-main)">${module}</strong>
                            <div style="font-size:0.8rem; color:var(--text-muted)">${status}</div>
                        </div>
                        ${btnHtml}
                    </div>
                `;
            }).join('')}
        </div>
    `;
    openModal('modal-year');
}

function updateModuleStatus(progressId, newStatus) {
    showLoading(true);
    google.script.run
        .withSuccessHandler(res => {
            if (res.success) {
                showToast('success', 'Progress recorded!');
                closeModal('modal-year');
                loadDashboardData(APP_STATE.currentMemberId);
            } else {
                showToast('error', 'Failed to update module');
            }
            showLoading(false);
        })
        .updateModuleStatus(progressId, newStatus);
}

function quickRecordSabbat(name) {
    const year = new Date().getFullYear();
    document.getElementById('att-type').value = 'Sabbat';
    document.getElementById('att-name').value = `${name} ${year}`;
    document.getElementById('att-date').valueAsDate = new Date();
    openModal('modal-record-attendance');
}

function submitAttendance(event) {
    event.preventDefault();
    showLoading(true);
    
    const data = {
        eventType: document.getElementById('att-type').value,
        eventName: document.getElementById('att-name').value,
        eventDate: document.getElementById('att-date').value,
        attended: document.getElementById('att-attended').checked,
        notes: document.getElementById('att-notes').value
    };
    
    google.script.run
        .withSuccessHandler(res => {
            if (res.success) {
                showToast('success', 'Attendance Recorded. So Mote It Be!');
                closeModal('modal-record-attendance');
                loadDashboardData(APP_STATE.currentMemberId);
            } else {
                showToast('error', 'Failed to record.');
            }
            showLoading(false);
        })
        .recordAttendance(APP_STATE.currentMemberId, data);
}

function openNewEntryModal() {
    document.getElementById('new-entry-form').reset();
    openModal('modal-new-entry');
}

function submitNewEntry(event) {
    event.preventDefault();
    showLoading(true);
    
    const data = {
        title: document.getElementById('entry-title').value,
        category: document.getElementById('entry-category').value,
        content: document.getElementById('entry-content').value,
        tags: document.getElementById('entry-tags').value,
        isPrivate: document.getElementById('entry-private').checked
    };
    
    google.script.run
        .withSuccessHandler(res => {
            if (res.success) {
                showToast('success', 'Entry inscribed in the Grimoire.');
                closeModal('modal-new-entry');
                loadDashboardData(APP_STATE.currentMemberId);
            } else {
                showToast('error', 'Failed to save entry.');
            }
            showLoading(false);
        })
        .createGrimoireEntry(APP_STATE.currentMemberId, data);
}

function viewGrimoireEntry(id) {
    const entry = APP_STATE.grimoire.entries.find(e => e.ID === id);
    if (!entry) return;
    
    const content = document.getElementById('view-entry-content');
    content.innerHTML = `
        <h2>${entry.Title}</h2>
        <p class="entry-date">Inscribed: ${formatDisplayDate(entry.CreatedDate)}</p>
        <hr style="border-color: rgba(255,255,255,0.1); margin: 1rem 0;">
        <div style="white-space: pre-wrap; line-height: 1.8;">${entry.Content}</div>
        <div style="margin-top:1.5rem; text-align:right">
            <button class="btn-secondary" style="border-color: var(--fire); color: var(--fire);" onclick="deleteEntry('${entry.ID}')">Burn Page</button>
        </div>
    `;
    openModal('modal-view-entry');
}

function deleteEntry(id) {
    if (!confirm('Burn this page from your Grimoire? This cannot be undone.')) return;
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(res => {
            if (res.success) {
                showToast('success', 'Page burned to ash.');
                closeModal('modal-view-entry');
                loadDashboardData(APP_STATE.currentMemberId);
            } else {
                showToast('error', 'The spell resists deletion.');
            }
            showLoading(false);
        })
        .deleteGrimoireEntry(id);
}

// Rituals
const RITUALS = {
    circle: { title: "Casting the Circle", content: "<p>1. Cleanse the space...</p><p>2. Call the quarters...</p>" },
    air: { title: "Element of Air", content: "<p>Hail to the East, Watchtower of Air...</p>" },
    fire: { title: "Element of Fire", content: "<p>Hail to the South, Watchtower of Fire...</p>" },
    water: { title: "Element of Water", content: "<p>Hail to the West, Watchtower of Water...</p>" },
    earth: { title: "Element of Earth", content: "<p>Hail to the North, Watchtower of Earth...</p>" }
};

function openRitualModal(key) {
    const ritual = RITUALS[key];
    if(!ritual) return;
    
    const content = document.getElementById('ritual-modal-content');
    content.innerHTML = `<h2>${ritual.title}</h2><div style="margin-top:1rem">${ritual.content}</div>`;
    openModal('modal-ritual');
}

// ğŸ”§ UTILITIES
function showLoading(show) {
    const overlay = document.getElementById('loading-overlay');
    if (show) overlay.classList.add('active');
    else overlay.classList.remove('active');
}

function showToast(type, msg) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<span>${type === 'success' ? 'âœ¨' : 'ğŸ”®'}</span><span>${msg}</span>`;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

function formatDisplayDate(str) {
    if (!str) return '';
    try {
        return new Date(str).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    } catch { return str; }
}

</script>